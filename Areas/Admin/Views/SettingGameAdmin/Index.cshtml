
@{
    ViewBag.Title = "Danh sách trò chơi trong hệ thống";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
    <div class="subheader py-2 py-lg-6 subheader-solid" id="kt_subheader">
        <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
            <div class="d-flex align-items-center flex-wrap mr-1">
                <h5 class="text-dark font-weight-bold my-1 mr-5">Danh sách trò chơi trong hệ thống</h5>
            </div>
        </div>
    </div>

    <div class="card card-custom">

        <div class="card-header flex-wrap border-0 pt-6 pb-0">

            <div class="card-title">

            </div>
            <div class="card-toolbar">
                <div class="dropdown dropdown-inline mr-2">
                    @*begin::Button**@
                    <a href="javascript:void(0)" data-toggle="modal" data-target="#UploadFileModal" class="btn btn-success font-weight-bolder">
                        <span class="svg-icon svg-icon-md">
                            @*begin::Svg Icon | path:assets/media/svg/icons/Design/Flatten.svg*@
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <polygon points="0 0 24 0 24 24 0 24" />
                                    <path d="M5.85714286,2 L13.7364114,2 C14.0910962,2 14.4343066,2.12568431 14.7051108,2.35473959 L19.4686994,6.3839416 C19.8056532,6.66894833 20,7.08787823 20,7.52920201 L20,20.0833333 C20,21.8738751 19.9795521,22 18.1428571,22 L5.85714286,22 C4.02044787,22 4,21.8738751 4,20.0833333 L4,3.91666667 C4,2.12612489 4.02044787,2 5.85714286,2 Z" fill="#000000" fill-rule="nonzero" opacity="0.3" />
                                    <path d="M8.95128003,13.8153448 L10.9077535,13.8153448 L10.9077535,15.8230161 C10.9077535,16.0991584 11.1316112,16.3230161 11.4077535,16.3230161 L12.4310522,16.3230161 C12.7071946,16.3230161 12.9310522,16.0991584 12.9310522,15.8230161 L12.9310522,13.8153448 L14.8875257,13.8153448 C15.1636681,13.8153448 15.3875257,13.5914871 15.3875257,13.3153448 C15.3875257,13.1970331 15.345572,13.0825545 15.2691225,12.9922598 L12.3009997,9.48659872 C12.1225648,9.27584861 11.8070681,9.24965194 11.596318,9.42808682 C11.5752308,9.44594059 11.5556598,9.46551156 11.5378061,9.48659872 L8.56968321,12.9922598 C8.39124833,13.2030099 8.417445,13.5185067 8.62819511,13.6969416 C8.71848979,13.773391 8.8329684,13.8153448 8.95128003,13.8153448 Z" fill="#000000" />
                                </g>
                            </svg>
                            @*end::Svg Icon*@
                        </span>Thêm file dữ liệu thẻ
                    </a>
                    @*end::Button*@
                </div>
                <a href="/Admin/SettingGameAdmin/Add" class="btn btn-primary font-weight-bolder">
                    <span class="svg-icon svg-icon-md">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <rect x="0" y="0" width="24" height="24" />
                                <circle fill="#000000" cx="9" cy="15" r="6" />
                                <path d="M8.8012943,7.00241953 C9.83837775,5.20768121 11.7781543,4 14,4 C17.3137085,4 20,6.6862915 20,10 C20,12.2218457 18.7923188,14.1616223 16.9975805,15.1987057 C16.9991904,15.1326658 17,15.0664274 17,15 C17,10.581722 13.418278,7 9,7 C8.93357256,7 8.86733422,7.00080962 8.8012943,7.00241953 Z" fill="#000000" opacity="0.3" />
                            </g>
                        </svg>
                    </span>Thêm
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-7">
                <div class="row align-items-center">
                    <div class="col-lg-9 col-xl-8">
                        <div class="row align-items-center">
                            <div class="col-md-4 my-2 my-md-0">
                                <div class="input-icon">
                                    <input type="text" class="form-control" placeholder="Tìm Kiếm..." id="kt_datatable_search_query" />
                                    <span>
                                        <i class="flaticon2-search-1 text-muted"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @*begin: Datatable*@
            <div class="table-responsive" style="position: relative; height: 440px; overflow: auto;">
                <table id="accounttable" class="table">
                    <thead style="position: sticky; top: 0px; background: white">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Id</th>
                            <th scope="col">Tên</th>
                            <th scope="col">Ngày Tạo</th>
                            <th scope="col">Người Tạo</th>
                            <th scope="col">Ngày Sửa</th>
                            <th scope="col">Người Sửa</th>
                            <th scope="col">Trạng Thái</th>
                            <th scope="col">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <div class="spinner spinner-success spinner-lg mr-15" style=" position: absolute; left: 50%; transform: translate(-50%, -50%);display:none"></div>
            </div>
            @*end: Datatable*@
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="d-flex flex-wrap py-2 mr-3">

                </div>
                <div class="d-flex align-items-center py-3">
                    <span class="text-muted" id="QtyNote"></span>
                </div>
            </div>
        </div>
        @*end::Card*@
    </div>
    @*end::Container*@
</div>
<div class="modal fade" id="UploadFileModal" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="staticBackdrop" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Nhập Excel</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </button>
            </div>
            <form id="uploadForm" method="POST">
                <div class="modal-body">

                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">Tệp nhập</label>
                        <div class="col-sm-9">
                            <input type="file" id="excelFile" class="form-control" name="file" />
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light-primary font-weight-bold" data-dismiss="modal">Đóng</button>
                    <button type="button" id="import" onclick="Import()" class="btn btn-primary font-weight-bold">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="~/Areas/assets/admin/upload/UploadFile.js"></script>
@section scripts{
    <script>
        function Import() {
            // Lấy file được chọn
            var file = $('#excelFile')[0].files[0];

            // Tạo đối tượng FormData để chứa file
            var formData = new FormData();
            formData.append('file', file);

            // Gửi yêu cầu Ajax đến server
            $.ajax({
                url: '/Admin/SettingGameAdmin/Import',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    Swal.fire({
                        title: 'Loading...',
                        allowOutsideClick: false,
                        onBeforeOpen: () => {
                            Swal.showLoading();
                        }
                    });
                },

                success: function (response) {
                    Swal.close();
                    if (response.status) {
                        toastr.success('Thêm thành công!')
                        $('#membercardtable').find('tbody').empty()
                        ShowTable(1)
                        $('#UploadFileModal').modal('hide')
                    }
                    else
                        toastr.error(response.message, 'Lỗi!')
                },
                error: function (xhr, status, error) {
                    Swal.close();
                    // Xử lý lỗi (nếu có)
                    toastr.error(error, 'Lỗi!')
                }
            });
        }
        var page = 1;
        var search = "";
        var isLoadingData = false;
        var isFull = false;
        (function DataTable() {
            
            ShowTable(page, search)
            $('.table-responsive').scroll(function () {
                search = $('#kt_datatable_search_query').val().trim()
                /* var element = $(this)[0];*/
                var scrollTop = $(this).scrollTop() + 3;
                var scrollHeight = $(this)[0].scrollHeight;
                var windowHeight = $(this).outerHeight();
             
                if (scrollTop + windowHeight >= scrollHeight && !isLoadingData && !isFull) {
            
                    // Đạt đến cuối trang và không đang lấy dữ liệu
                    $('.spinner').show();
                    // Gọi hàm để lấy dữ liệu tiếp theo
                    ShowTable(page, search);
                }
            });
        })()

        $('#kt_datatable_search_query').keypress(function (e) {
            if (e.which == 13) {
                $('#accounttable').find('tbody').empty()
                search = $('#kt_datatable_search_query').val().trim()
                ShowTable(1, search)
            }
        })
        function ShowTable(pagenumber, search) {

            $.ajax({
                type: "GET",
                url: "/Admin/SettingGameAdmin/DataTable",
                data: {
                    page: pagenumber, search: search
                },

                datatype: 'json',
                success: function (data) {
                    let $table = $('#accounttable')
                    let body = $table.find('tbody')


                    //Hiển thị dữ liệu trong bảng
                    if (data.data && data.data.length > 0) {

                        $.each(data.data, function (i, v) {
                            let tr = `<tr>
    <th scope="row">${((10 * (data.pageCurrent - 1)) + (i + 1))}</th>
    <td>${v.Id}</td>
    <td>${v.Name}</td>
    <td>${formatDate(v.CreateDate)}</td>
    <td>${v.CreateBy}</td>
    <td>${formatDate(v.ModifyDate)}</td>
    <td>${v.ModifyBy}</td>
    <td>${v.Status}</td>
    <td nowrap="nowrap">
        <a href="/Admin/SettingGameAdmin/Edit/${v.Id}" class="btn btn-sm btn-clean btn-icon" title="Sửa">
            <i class="la la-edit"></i>
        </a>
        <a id="delete${v.Id}" name="delete" class="btn btn-sm btn-clean btn-icon" title="Xóa">
            <i class="la la-trash"></i>
        </a>
    </td>
</tr>`
                            body.append(tr)
                        })
                        pagenumber++
                        page = pagenumber
                    } else {
                        isFull = true
                    }
                    $('.spinner').hide();
                    isLoadingData = false;
                    $('#QtyNote').text(`Displaying ${data.to} of ${data.total} records`)



                },
                error: function () {
                    // Xử lý lỗi (nếu cần thiết)
                    // Ẩn loading indicator và cho phép lấy dữ liệu tiếp theo
                    $('.spinner').hide();
                    isLoadingData = false;
                }
            })
        }
        $(document).on('click', 'a[name="delete"]', function () {
            Swal.fire({
                title: 'Chắc chắn muốn xóa?',
                text: "dữ liệu không thể hồi phục!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa!'
            }).then((result) => {
                if (result.isConfirmed) {
                    var id = $(this).attr('id').replace("delete", "")
                    $.ajax({
                        type: "POST",
                        url: "/Admin/SettingGameAdmin/Delete",
                        data: { id: id },
                        success: function (result) {
                            if (result.status == "success") {
                                toastr.success("Xóa Thành Công")
                                $('#accounttable').find('tbody').empty()
                                ShowTable(1, search)
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Đã có lỗi xảy ra, vui lòng thử lại!',
                                    text: result.message,
                                    showConfirmButton: false,
                                    timer: 1500
                                })
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'Something wrong!',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        }
                    })

                }
            })
        })
    </script>
}

